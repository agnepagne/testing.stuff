name: Minioclient Debug

on:
  workflow_dispatch:   # manual trigger ‚Äì you can also add push/pull_request etc.

jobs:
  install-minioclient:
    runs-on: windows-latest
    steps:
      # ---------------------------------------------------------
      # 0Ô∏è‚É£  Checkout (needed for a clean R session)
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 1Ô∏è‚É£  Set up R (same version you used elsewhere)
      # ---------------------------------------------------------
      - name: Install R (v4.4)
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.4'
          use-public-rspm: true

      # ---------------------------------------------------------
      # 2Ô∏è‚É£  Install the `remotes` package (used for install_github)
      # ---------------------------------------------------------
      - name: Install remotes package
        run: install.packages('remotes', repos='https://cloud.r-project.org')
        shell: Rscript {0}

      # ---------------------------------------------------------
      # 3Ô∏è‚É£  (Optional) Export a PAT to avoid GitHub rate limits
      # ---------------------------------------------------------
      - name: Export GitHub PAT (if you have one)
        env:
          GITHUB_PAT: ${{ secrets.GITHUB_PAT }}   # create this secret if you need it
        run: |
          if ($env:GITHUB_PAT) {
            echo "GITHUB_PAT=$env:GITHUB_PAT" >> $GITHUB_ENV
            Write-Host "‚úÖ PAT exported for remotes"
          } else {
            Write-Host "‚ö†Ô∏è No PAT supplied ‚Äì using anonymous API (rate‚Äëlimited)."
          }
        shell: pwsh

      # ---------------------------------------------------------
      # 4Ô∏è‚É£  Write a tiny R script that does the install
      # ---------------------------------------------------------
      - name: Write R installer script
        run: |
          $rScript = @"
          # ------------------------------------------------------------
          # Show a few env vars (helps debugging)
          # ------------------------------------------------------------
          cat('--- ENV BEFORE INSTALL ---\n')
          print(Sys.getenv())
          cat('\n--- START minioclient install ---\n')
          
          remotes::install_github(
            repo = 'cboettig/minioclient',
            ref  = 'main',
            upgrade = 'never',
            dependencies = FALSE,
            quiet = FALSE
          )
          
          cat('\n--- END minioclient install ---\n')
          "@
          $scriptPath = Join-Path $env:TEMP 'install_minioclient.R'
          Set-Content -Path $scriptPath -Value $rScript -Encoding UTF8
          Write-Host "‚úÖ R script written to $scriptPath"
          echo "R_SCRIPT=$scriptPath" >> $GITHUB_ENV
        shell: pwsh

      # ---------------------------------------------------------
      # 5Ô∏è‚É£  **Create a unique log folder** and remember its path
      # ---------------------------------------------------------
      - name: Prepare a unique log folder
        id: log_prep
        run: |
          $baseTmp = "${{ runner.temp }}"
          $runId   = [guid]::NewGuid().ToString()
          $logDir  = Join-Path $baseTmp "minioclient_debug_$runId"
          New-Item -ItemType Directory -Path $logDir -Force | Out-Null
          Write-Host "LOGDIR=$logDir" >> $GITHUB_ENV   # make it available to later steps
          Write-Host "‚úÖ Created log folder: $logDir"
        shell: pwsh

      # ---------------------------------------------------------
      # 6Ô∏è‚É£  Run the R script **and pipe everything to a log file**
      # ---------------------------------------------------------
      - name: Run R installer and capture log
        id: run_install
        env:
          LOGDIR: ${{ env.LOGDIR }}   # comes from the previous step
        run: |
          $logFile = Join-Path $env:LOGDIR 'minioclient_install.log'
          Write-Host "üóíÔ∏è Log will be written to $logFile"

          # `tee` writes to the file *and* forwards the output to the job log.
          # The `2>&1` ensures both stdout and stderr are captured.
          Rscript $env:R_SCRIPT 2>&1 | Tee-Object -FilePath $logFile
          $rc = $LASTEXITCODE

          Write-Host "‚úÖ R script finished ‚Äì exit code $rc"
          Write-Host "üìÑ Log saved at $logFile"

          # Export for the artifact step
          echo "install_rc=$rc"   >> $GITHUB_OUTPUT
          echo "log_path=$logFile" >> $GITHUB_OUTPUT
        shell: pwsh

      # ---------------------------------------------------------
      # 7Ô∏è‚É£  **Always** upload the log (even if the install failed)
      # ---------------------------------------------------------
      - name: Upload install log as artifact
        if: always()                     # run regardless of success/failure
        uses: actions/upload-artifact@v4
        with:
          name: minioclient-debug-logs
          path: ${{ steps.run_install.outputs.log_path }}
