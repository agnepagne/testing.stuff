name: Minioclient debug

on:
  workflow_dispatch:

jobs:
  install-minioclient:
    runs-on: windows-latest
    steps:
      # -------------------------------------------------------------
      # 1Ô∏è‚É£  Checkout (needed for a fresh R session)
      # -------------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # -------------------------------------------------------------
      # 2Ô∏è‚É£  Set up a short‚Äëlived temp directory and expose it as $MINIOTMP
      # -------------------------------------------------------------
      - name: Prepare temporary folder
        id: prep_tmp
        run: |
          # $env:TEMP is the runner‚Äôs built‚Äëin temp folder (always exists)
          $runId   = [guid]::NewGuid().ToString()
          $tmpDir  = Join-Path $env:TEMP "minioclient_debug_$runId"
          New-Item -ItemType Directory -Path $tmpDir -Force | Out-Null
          Write-Host "TMPDIR=$tmpDir" >> $env:GITHUB_ENV   # make it available to later steps
          Write-Host "Created temp dir: $tmpDir"
        shell: pwsh

      # -------------------------------------------------------------
      # 3Ô∏è‚É£  Install R (v4.4) ‚Äì same version you used elsewhere
      # -------------------------------------------------------------
      - name: Install R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.4'
          use-public-rspm: true

      # -------------------------------------------------------------
      # 4Ô∏è‚É£  Install the `remotes` package (needed for install_github)
      # -------------------------------------------------------------
      - name: Install remotes package
        run: install.packages('remotes', repos='https://cloud.r-project.org')
        shell: Rscript {0}

      # -------------------------------------------------------------
      # 5Ô∏è‚É£  (Optional) Export a PAT to avoid GitHub rate limits
      # -------------------------------------------------------------
      - name: Export GitHub PAT (if you have one)
        env:
          GITHUB_PAT: ${{ secrets.GITHUB_PAT }}   # create this secret if you need it
        run: |
          if ($env:GITHUB_PAT) {
            echo "GITHUB_PAT=$env:GITHUB_PAT" >> $GITHUB_ENV
            Write-Host "‚úÖ PAT exported for remotes"
          } else {
            Write-Host "‚ö†Ô∏è No PAT supplied ‚Äì using anonymous API (rate‚Äëlimited)."
          }
        shell: pwsh

      # -------------------------------------------------------------
      # 6Ô∏è‚É£  Write the R script that will install minioclient
      # -------------------------------------------------------------
      - name: Write R installer script
        run: |
          $rScript = @"
          # ------------------------------------------------------------
          # Show environment (helps debugging)
          # ------------------------------------------------------------
          cat('--- ENV BEFORE INSTALL ---\n')
          print(Sys.getenv())
          cat('\n--- START minioclient install ---\n')
          
          remotes::install_github(
            repo = 'cboettig/minioclient',
            ref  = 'main',
            upgrade = 'never',
            dependencies = FALSE,
            quiet = FALSE
          )
          
          cat('\n--- END minioclient install ---\n')
          "@
          $scriptPath = Join-Path $env:TEMP 'install_minioclient.R'
          Set-Content -Path $scriptPath -Value $rScript -Encoding UTF8
          Write-Host "‚úÖ R script written to $scriptPath"
          echo "R_SCRIPT=$scriptPath" >> $GITHUB_ENV
        shell: pwsh

      # -------------------------------------------------------------
      # 7Ô∏è‚É£  Run the R script, capture everything to a log file
      # -------------------------------------------------------------
      - name: Run R script and capture log
        id: run_install
        env:
          MINIOTMP: ${{ env.TMPDIR }}   # <-- comes from step 2
        run: |
          $logFile = Join-Path $env:MINIOTMP 'minioclient_install.log'
          Write-Host "Log will be written to $logFile"

          # Execute the R script; redirect both stdout and stderr to the log
          Rscript $env:R_SCRIPT *> $logFile
          $rc = $LASTEXITCODE

          Write-Host "‚úÖ Installation finished ‚Äì log saved to $logFile"
          Write-Host "üîé Rscript exit code: $rc"

          # Export values for later steps
          echo "install_rc=$rc"   >> $GITHUB_OUTPUT
          echo "log_path=$logFile" >> $GITHUB_OUTPUT
        shell: pwsh

      # -------------------------------------------------------------
      # 8Ô∏è‚É£  Upload the log **even if the install failed**
      # -------------------------------------------------------------
      - name: Upload install log as artifact
        if: always()                               # run regardless of success/failure
        uses: actions/upload-artifact@v4
        with:
          name: minioclient-debug-logs
          path: ${{ steps.run_install.outputs.log_path }}
