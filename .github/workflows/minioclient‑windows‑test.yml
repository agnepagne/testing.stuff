name: Test minioclient install (Windows only)

on:
  workflow_dispatch:          # manual trigger

jobs:
  windows-minioclient:
    runs-on: windows-latest
    env:
      R_REMOTES_NO_ERRORS_FROM_WARNINGS: true   # keep warnings from aborting

    steps:
      # ---------------------------------------------------------
      # 1️⃣ Checkout (optional, just keeps the workspace tidy)
      # ---------------------------------------------------------
      - name: Checkout repository
        uses: actions/checkout@v4

      # ---------------------------------------------------------
      # 2️⃣ Install R (this also pulls in the default Rtools version)
      # ---------------------------------------------------------
      - name: Set up R
        uses: r-lib/actions/setup-r@v2
        with:
          r-version: '4.4'          # same version you use locally
          use-public-rspm: true
          windows-path-include-rtools: true   # put Rtools on PATH

      # ---------------------------------------------------------
      # 3️⃣ Install additional Windows system libs needed by minioclient
      # ---------------------------------------------------------
      - name: Install OpenSSL, pkg‑config and CMake
        run: |
          choco install openssl.light -y
          choco install pkgconfiglite -y
          choco install cmake -y

      # ---------------------------------------------------------
      # 4️⃣ Cache the user library (speeds up repeated runs)
      # ---------------------------------------------------------
      - name: Cache R packages
        uses: actions/cache@v3
        with:
          path: ${{ env.R_LIBS_USER }}
          key: windows-r-${{ hashFiles('**/*.R') }}
          restore-keys: windows-r-

      # ---------------------------------------------------------
      # 5️⃣ Install the `remotes` helper package (needed for GitHub installs)
      # ---------------------------------------------------------
      - name: Install remotes package
        env:
          GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
        run: |
          Rscript -e 'install.packages("remotes", repos = "https://cloud.r-project.org")'

      # ---------------------------------------------------------
      # 6️⃣ Install minioclient – **verbose** (forced logging, PowerShell‑compatible)
      # ---------------------------------------------------------
      - name: Install minioclient (verbose, with forced logging)
        env:
          GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # ---------- PowerShell helper to emit a notice line ----------
          function Log-Notice {
            param([string]$Message)
            Write-Host "::notice title=minioclient-debug::$Message"
          }

          # ---------- 1️⃣ Show basic environment info ----------
          Rscript -e '
            cat("=== R session info ===\n")
            print(sessionInfo())
            cat("\n=== .libPaths() ===\n")
            print(.libPaths())
            cat("\n=== PATH (first 200 chars) ===\n")
            cat(substr(Sys.getenv("PATH"), 1, 200), "\n")
            cat("GITHUB_PAT set? ", n
